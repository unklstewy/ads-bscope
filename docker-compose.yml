services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: adsbscope-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: adsbscope
      POSTGRES_USER: adsbscope
      POSTGRES_PASSWORD: ${DB_PASSWORD:-changeme}
      # Performance tuning
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C"
    volumes:
      # Persistent database storage
      - postgres_data:/var/lib/postgresql/data
      # Database initialization scripts (when they exist)
      - ./scripts/db:/docker-entrypoint-initdb.d
      # Custom PostgreSQL configuration (optional)
      - ./configs/postgresql.conf:/etc/postgresql/postgresql.conf:ro
    ports:
      # Expose for local development tools (pgAdmin, psql, etc.)
      - "5432:5432"
    networks:
      - adsbscope-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U adsbscope -d adsbscope"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    # Resource limits (adjust based on workload)
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # Collector Service (main ADS-B data collector)
  collector:
    build:
      context: .
      dockerfile: Dockerfile
      target: collector
    container_name: adsbscope-collector
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Database connection
      ADS_BSCOPE_DB_HOST: postgres
      ADS_BSCOPE_DB_PORT: 5432
      ADS_BSCOPE_DB_USER: adsbscope
      ADS_BSCOPE_DB_PASSWORD: ${DB_PASSWORD:-changeme}
      ADS_BSCOPE_DB_NAME: adsbscope
      # ADS-B API configuration
      ADS_BSCOPE_ADSB_API_KEY: ${ADSB_API_KEY:-}
      ADS_BSCOPE_ADSB_SOURCE: ${ADSB_SOURCE:-airplaneslive}
      # Application configuration
      CONFIG_PATH: /app/configs/config.json
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-info}
      TZ: ${TZ:-UTC}
    ports:
      - "8080:8080"
    networks:
      - adsbscope-network
    volumes:
      # Mount config for easy editing without rebuild
      - ./configs/config.json:/app/configs/config.json:ro
      # Optional: Mount logs directory
      - ./logs:/app/logs
    healthcheck:
      test: ["./collector", "--health-check"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  # Fetch Flightplans Service (periodic job)
  fetch-flightplans:
    build:
      context: .
      dockerfile: Dockerfile
      target: fetch-flightplans
    container_name: adsbscope-fetch-flightplans
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      ADS_BSCOPE_DB_HOST: postgres
      ADS_BSCOPE_DB_PORT: 5432
      ADS_BSCOPE_DB_USER: adsbscope
      ADS_BSCOPE_DB_PASSWORD: ${DB_PASSWORD:-changeme}
      ADS_BSCOPE_DB_NAME: adsbscope
      CONFIG_PATH: /app/configs/config.json
      LOG_LEVEL: ${LOG_LEVEL:-info}
      TZ: ${TZ:-UTC}
    networks:
      - adsbscope-network
    volumes:
      - ./configs/config.json:/app/configs/config.json:ro
      - ./logs:/app/logs
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M

  # Verify NASR Service (one-time or periodic verification)
  verify-nasr:
    build:
      context: .
      dockerfile: Dockerfile
      target: verify-nasr
    container_name: adsbscope-verify-nasr
    restart: "no"  # Run once
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      ADS_BSCOPE_DB_HOST: postgres
      ADS_BSCOPE_DB_PORT: 5432
      ADS_BSCOPE_DB_USER: adsbscope
      ADS_BSCOPE_DB_PASSWORD: ${DB_PASSWORD:-changeme}
      ADS_BSCOPE_DB_NAME: adsbscope
      CONFIG_PATH: /app/configs/config.json
      LOG_LEVEL: ${LOG_LEVEL:-info}
      TZ: ${TZ:-UTC}
    networks:
      - adsbscope-network
    volumes:
      - ./configs/config.json:/app/configs/config.json:ro
      - ./logs:/app/logs
    profiles:
      - tools  # Only run when explicitly requested

  # Verify Flightplans Service (one-time or periodic verification)
  verify-flightplans:
    build:
      context: .
      dockerfile: Dockerfile
      target: verify-flightplans
    container_name: adsbscope-verify-flightplans
    restart: "no"  # Run once
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      ADS_BSCOPE_DB_HOST: postgres
      ADS_BSCOPE_DB_PORT: 5432
      ADS_BSCOPE_DB_USER: adsbscope
      ADS_BSCOPE_DB_PASSWORD: ${DB_PASSWORD:-changeme}
      ADS_BSCOPE_DB_NAME: adsbscope
      CONFIG_PATH: /app/configs/config.json
      LOG_LEVEL: ${LOG_LEVEL:-info}
      TZ: ${TZ:-UTC}
    networks:
      - adsbscope-network
    volumes:
      - ./configs/config.json:/app/configs/config.json:ro
      - ./logs:/app/logs
    profiles:
      - tools  # Only run when explicitly requested

networks:
  adsbscope-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  postgres_data:
    driver: local
